# The top-level Makefile that is used to build the HTML5 specification
#
# Author: Manu Sporny
.PHONY: help all spec-rdfa-module spec-rdfa-complete directories

BUILD_DIR := build
DIST_DIR := dist

help:
	@echo "Commands that you can use to build the HTML5 specification."
	@echo ""
	@echo " make whatwg-pull - Pull the latest updates from the WHAT WG repository"
	@echo " make html5-hixie - Build the HTML5 specification"
	@echo " make html5-rdfa - Build the RDFa specification module"
	@echo " make rdfa-module - Build the HTML5+RDFa specification"
	@echo " make clean - Cleans all of the build files"

whatwg-pull:
	@echo "Pulling latest changes from WHAT Working Group repository"
	@@SVN@ co http://svn.whatwg.org/webapps html5-hixie

directories:
	@mkdir -p ${BUILD_DIR} ${DIST_DIR}

html5-hixie: directories ${DIST_DIR}/html5-hixie.html

${DIST_DIR}/html5-hixie.html: headers/header-w3c-html5 html5-hixie/source
	@echo "Building HTML5-hixie specification..."
	@echo "Splitting html5-hixie into microsections..."
	@./bin/microsplit.py html5-hixie/source
	@echo "Joining microsections into HTML5-hixie specification..."
	@echo "include headers/header-w3c-html5" > build/html5-hixie.conf
	@cat build/source.conf >> build/html5-hixie.conf
	@./bin/microjoin.py build/html5-hixie.conf
	@echo "Generating final document via Anolis (this may take 2-3 minutes)..."
	@@ANOLIS@ @ANOLIS_FLAGS@ ${BUILD_DIR}/specification.html ${DIST_DIR}/html5-hixie.html
	@echo "HTML5-hixie spec written to: ${DIST_DIR}/html5-hixie.html"

rdfa-module: directories ${DIST_DIR}/rdfa-module.html

${DIST_DIR}/rdfa-module.html: headers/header-w3c-rdfa $(wildcard microsections/rdfa/*)
	@echo "Building modularized RDFa specification..."
	@echo "Joining RDFa microsections into RDFa module specification..."
	@./bin/microjoin.py configs/rdfa-module.conf
	@echo "Generating final HTML via Anolis..."
	@@ANOLIS@ @ANOLIS_FLAGS@ ${BUILD_DIR}/specification.html ${DIST_DIR}/rdfa-module.html
	@echo "RDFa module spec written to: ${DIST_DIR}/rdfa-module.html"

html5-rdfa: directories ${DIST_DIR}/html5-rdfa.html

html5-hixie/source: whatwg-pull

${DIST_DIR}/html5-rdfa.html: headers/header-w3c-html5 html5-hixie/source $(wildcard microsections/rdfa/*)
	@echo "Building HTML5+RDFa specification..."
	@mkdir -p ${BUILD_DIR} ${DIST_DIR}
	@echo "Joining RDFa microsections into RDFa module specification..."
	@./bin/microjoin.py configs/html5-rdfa.conf
	@echo "Generating final HTML via Anolis (this may take 2-3 minutes)..."
	@@ANOLIS@ @ANOLIS_FLAGS@ ${BUILD_DIR}/specification.html ${DIST_DIR}/html5-rdfa.html
	@echo "HTM5-RDFa spec written to: ${DIST_DIR}/html5-rdfa.html"

html5-warnings: directories ${DIST_DIR}/html5-warnings.html

${DIST_DIR}/html5-warnings.html: headers/header-w3c-msporny html5-hixie/source $(wildcard microsections/warnings/*)
	@echo "Building HTML5-warnings specification..."
	@mkdir -p ${BUILD_DIR} ${DIST_DIR}
	@echo "Joining HTML5-warnings microsections into HTML5 specification..."
	@./bin/microjoin.py configs/html5-warnings.conf
	@echo "Replacing specification name links"
	@sed -i "s/@SPEC_NAME@/html5-warnings/g" ${BUILD_DIR}/specification.html
	@echo "Generating final HTML via Anolis (this may take 2-3 minutes)..."
	@@ANOLIS@ @ANOLIS_FLAGS@ ${BUILD_DIR}/specification.html ${DIST_DIR}/html5-warnings.html
	@echo "HTM5-warnings spec written to: ${DIST_DIR}/html5-warnings.html"

html5-warnings-module: directories ${DIST_DIR}/html5-warnings-module.html

${DIST_DIR}/html5-warnings-module.html: headers/header-w3c-msporny $(wildcard microsections/warnings/*)
	@echo "Building modularized HTML5-warnings specification..."
	@echo "Joining HTML5-warnings microsections into HTML5-warnings module specification..."
	@./bin/microjoin.py configs/html5-warnings-module.conf
	@echo "Replacing specification name links"
	@sed -i "s/@SPEC_NAME@/html5-warnings/g" ${BUILD_DIR}/specification.html 
	@echo "Generating final HTML via Anolis..."
	@@ANOLIS@ @ANOLIS_FLAGS@ ${BUILD_DIR}/specification.html ${DIST_DIR}/html5-warnings-module.html
	@echo "HTML5-warnings module spec written to: ${DIST_DIR}/html5-warnings-module.html"

clean:
	@echo "Cleaning all build files and directories..."
	@rm -rf html5-hixie
	@rm -f *~
	@rm -rf configure config.status config.log Makefile autom4te.cache
	@rm -rf ${BUILD_DIR} ${DIST_DIR}
